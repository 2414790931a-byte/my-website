<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 导出数据锚点 -->
    <script id="export-data-hook">window.NSH_EXPORTED_DATA = {"rawData":{"gA":{"name":"横戈","players":[{"id":"花萦","name":"花萦","job":"素问","killStr":"0/0","kill":0,"assist":70,"res":0,"dmg":1866802,"tower":470523,"heal":216494312,"taken":43683251,"dead":3,"reviveStr":"6","revive":6,"fengu":0,"guildName":"横戈"},{"id":"知源","name":"知源","job":"铁衣","killStr":"1/0","kill":1,"assist":95,"res":0,"dmg":27839681,"tower":0,"heal":7818864,"taken":209722308,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"奔雷","name":"奔雷","job":"碎梦","killStr":"18/7","kill":25,"assist":38,"res":0,"dmg":106610966,"tower":0,"heal":3144238,"taken":40569832,"dead":12,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"加加子","name":"加加子","job":"铁衣","killStr":"1/1","kill":2,"assist":65,"res":0,"dmg":23128235,"tower":6763223,"heal":3702632,"taken":86152457,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"东方月初","name":"东方月初","job":"潮光","killStr":"1/0","kill":1,"assist":39,"res":0,"dmg":20500831,"tower":24425445,"heal":6713678,"taken":27766034,"dead":2,"reviveStr":"8","revive":8,"fengu":0,"guildName":"横戈"},{"id":"寒蟬丶","name":"寒蟬丶","job":"龙吟","killStr":"6/0","kill":6,"assist":38,"res":0,"dmg":48516717,"tower":39476377,"heal":1227293,"taken":25910438,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"月揽霜","name":"月揽霜","job":"素问","killStr":"0/0","kill":0,"assist":68,"res":0,"dmg":2908285,"tower":0,"heal":238026796,"taken":74817207,"dead":0,"reviveStr":"17","revive":17,"fengu":0,"guildName":"横戈"},{"id":"邀明月","name":"邀明月","job":"玄机","killStr":"12/2","kill":14,"assist":42,"res":0,"dmg":109775910,"tower":3741504,"heal":2732449,"taken":43209908,"dead":2,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"醉千千","name":"醉千千","job":"沧澜","killStr":"2/1","kill":3,"assist":41,"res":0,"dmg":41189653,"tower":29869802,"heal":35311,"taken":56228885,"dead":1,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"下次一定","name":"下次一定","job":"血河","killStr":"7/2","kill":9,"assist":48,"res":0,"dmg":134833801,"tower":0,"heal":14021784,"taken":61607667,"dead":3,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"祺祺","name":"祺祺","job":"素问","killStr":"0/0","kill":0,"assist":66,"res":0,"dmg":531176,"tower":151649,"heal":111128676,"taken":28887541,"dead":0,"reviveStr":"1","revive":1,"fengu":0,"guildName":"横戈"},{"id":"白晶晶","name":"白晶晶","job":"素问","killStr":"0/0","kill":0,"assist":64,"res":0,"dmg":262138,"tower":12459,"heal":96932465,"taken":45688577,"dead":1,"reviveStr":"4","revive":4,"fengu":0,"guildName":"横戈"},{"id":"孔少","name":"孔少","job":"碎梦","killStr":"18/8","kill":26,"assist":36,"res":0,"dmg":127446861,"tower":0,"heal":26000,"taken":36255862,"dead":5,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"清椽","name":"清椽","job":"潮光","killStr":"2/0","kill":2,"assist":70,"res":0,"dmg":35023927,"tower":0,"heal":19387941,"taken":70634941,"dead":0,"reviveStr":"7","revive":7,"fengu":0,"guildName":"横戈"},{"id":"塔左那个潮光","name":"塔左那个潮光","job":"神相","killStr":"9/5","kill":14,"assist":61,"res":0,"dmg":120168088,"tower":0,"heal":3640240,"taken":55874149,"dead":8,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"凡也","name":"凡也","job":"玄机","killStr":"14/7","kill":21,"assist":45,"res":0,"dmg":121524337,"tower":3699689,"heal":2353065,"taken":32877967,"dead":9,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"拓海","name":"拓海","job":"九灵","killStr":"5/2","kill":7,"assist":65,"res":0,"dmg":149732428,"tower":0,"heal":2083077,"taken":62164119,"dead":5,"reviveStr":"0","revive":0,"fengu":18,"guildName":"横戈"},{"id":"温言","name":"温言","job":"九灵","killStr":"6/2","kill":8,"assist":56,"res":0,"dmg":157546792,"tower":0,"heal":1708415,"taken":42221226,"dead":6,"reviveStr":"0","revive":0,"fengu":7,"guildName":"横戈"},{"id":"清尔","name":"清尔","job":"碎梦","killStr":"17/10","kill":27,"assist":35,"res":0,"dmg":111307002,"tower":934682,"heal":40000,"taken":41637700,"dead":7,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"琳恩","name":"琳恩","job":"神相","killStr":"5/3","kill":8,"assist":68,"res":0,"dmg":112814433,"tower":0,"heal":4597042,"taken":84969584,"dead":11,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"小陆远","name":"小陆远","job":"龙吟","killStr":"2/0","kill":2,"assist":43,"res":0,"dmg":43155488,"tower":34335773,"heal":2548820,"taken":45613682,"dead":1,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"桃沫","name":"桃沫","job":"素问","killStr":"0/0","kill":0,"assist":67,"res":0,"dmg":1726872,"tower":270153,"heal":127211368,"taken":56815238,"dead":0,"reviveStr":"6","revive":6,"fengu":0,"guildName":"横戈"},{"id":"咬鹃","name":"咬鹃","job":"血河","killStr":"5/2","kill":7,"assist":50,"res":0,"dmg":91347860,"tower":1609781,"heal":8041453,"taken":67427257,"dead":2,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"婉心","name":"婉心","job":"素问","killStr":"0/0","kill":0,"assist":73,"res":0,"dmg":3569736,"tower":0,"heal":235851616,"taken":87505392,"dead":0,"reviveStr":"14","revive":14,"fengu":0,"guildName":"横戈"},{"id":"檀柠","name":"檀柠","job":"素问","killStr":"0/0","kill":0,"assist":66,"res":0,"dmg":482898,"tower":12925,"heal":126123205,"taken":26226887,"dead":0,"reviveStr":"6","revive":6,"fengu":0,"guildName":"横戈"},{"id":"天蝎","name":"天蝎","job":"沧澜","killStr":"4/0","kill":4,"assist":46,"res":0,"dmg":78207959,"tower":44329154,"heal":174977,"taken":41396539,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"浅念丶","name":"浅念丶","job":"潮光","killStr":"0/0","kill":0,"assist":42,"res":0,"dmg":44396312,"tower":26291764,"heal":10750256,"taken":37865423,"dead":0,"reviveStr":"5","revive":5,"fengu":0,"guildName":"横戈"},{"id":"京剧","name":"京剧","job":"潮光","killStr":"5/4","kill":9,"assist":95,"res":0,"dmg":104653042,"tower":0,"heal":14385080,"taken":43380493,"dead":7,"reviveStr":"13","revive":13,"fengu":0,"guildName":"横戈"},{"id":"超级万万","name":"超级万万","job":"铁衣","killStr":"2/1","kill":3,"assist":60,"res":0,"dmg":30898359,"tower":5151856,"heal":3978253,"taken":154885779,"dead":2,"reviveStr":"0","revive":0,"fengu":0,"guildName":"横戈"},{"id":"林志玲","name":"林志玲","job":"潮光","killStr":"4/0","kill":4,"assist":58,"res":0,"dmg":20912834,"tower":20928734,"heal":11392167,"taken":30264222,"dead":1,"reviveStr":"14","revive":14,"fengu":0,"guildName":"横戈"}]},"gB":{"name":"仗剑","players":[{"id":"柠澈澈","name":"柠澈澈","job":"神相","killStr":"5/4","kill":9,"assist":30,"res":0,"dmg":147587438,"tower":0,"heal":3213677,"taken":76827621,"dead":7,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"乐乐崽","name":"乐乐崽","job":"铁衣","killStr":"0/0","kill":0,"assist":68,"res":0,"dmg":18103933,"tower":842476,"heal":6046332,"taken":132785186,"dead":4,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"约束","name":"约束","job":"碎梦","killStr":"14/3","kill":17,"assist":25,"res":0,"dmg":81958720,"tower":484869,"heal":2845698,"taken":56991555,"dead":11,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"极意","name":"极意","job":"碎梦","killStr":"11/7","kill":18,"assist":12,"res":0,"dmg":94061567,"tower":0,"heal":2441098,"taken":48187865,"dead":11,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"愛止痛","name":"愛止痛","job":"血河","killStr":"7/4","kill":11,"assist":35,"res":0,"dmg":135852750,"tower":1627117,"heal":11804251,"taken":43936348,"dead":3,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"牙牙","name":"牙牙","job":"素问","killStr":"0/0","kill":0,"assist":35,"res":0,"dmg":2313907,"tower":0,"heal":261308073,"taken":96441841,"dead":6,"reviveStr":"18","revive":18,"fengu":0,"guildName":"仗剑"},{"id":"孙悟空","name":"孙悟空","job":"血河","killStr":"5/0","kill":5,"assist":19,"res":0,"dmg":101263913,"tower":0,"heal":14005856,"taken":61906693,"dead":8,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"几分心动","name":"几分心动","job":"龙吟","killStr":"1/0","kill":1,"assist":20,"res":0,"dmg":24609491,"tower":23060696,"heal":900000,"taken":52186638,"dead":9,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小烬川","name":"小烬川","job":"碎梦","killStr":"1/12","kill":13,"assist":21,"res":0,"dmg":76798817,"tower":0,"heal":2142168,"taken":40194435,"dead":5,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小飞鼠","name":"小飞鼠","job":"素问","killStr":"0/0","kill":0,"assist":50,"res":0,"dmg":1809089,"tower":143441,"heal":106809055,"taken":36253032,"dead":0,"reviveStr":"8","revive":8,"fengu":0,"guildName":"仗剑"},{"id":"雁鸣","name":"雁鸣","job":"沧澜","killStr":"4/1","kill":5,"assist":20,"res":0,"dmg":43875382,"tower":22762908,"heal":1648743,"taken":39441205,"dead":2,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"席枫","name":"席枫","job":"铁衣","killStr":"0/0","kill":0,"assist":25,"res":0,"dmg":12385881,"tower":0,"heal":8054003,"taken":177841472,"dead":3,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"忘忧鱼","name":"忘忧鱼","job":"九灵","killStr":"2/0","kill":2,"assist":24,"res":0,"dmg":130722616,"tower":0,"heal":2699913,"taken":58241489,"dead":11,"reviveStr":"0","revive":0,"fengu":2,"guildName":"仗剑"},{"id":"小酸","name":"小酸","job":"玄机","killStr":"14/3","kill":17,"assist":35,"res":0,"dmg":130426383,"tower":2998429,"heal":2810531,"taken":74073016,"dead":7,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"梦游大王","name":"梦游大王","job":"九灵","killStr":"1/1","kill":2,"assist":36,"res":0,"dmg":115762661,"tower":0,"heal":2273918,"taken":53283948,"dead":2,"reviveStr":"0","revive":0,"fengu":3,"guildName":"仗剑"},{"id":"浔梓","name":"浔梓","job":"潮光","killStr":"2/1","kill":3,"assist":54,"res":0,"dmg":57661435,"tower":0,"heal":14122557,"taken":49887493,"dead":7,"reviveStr":"15","revive":15,"fengu":0,"guildName":"仗剑"},{"id":"小星河","name":"小星河","job":"潮光","killStr":"1/0","kill":1,"assist":39,"res":0,"dmg":26844550,"tower":15802239,"heal":11635068,"taken":37692027,"dead":2,"reviveStr":"10","revive":10,"fengu":0,"guildName":"仗剑"},{"id":"凌仙","name":"凌仙","job":"沧澜","killStr":"0/1","kill":1,"assist":31,"res":0,"dmg":29779695,"tower":24992501,"heal":2369610,"taken":49418167,"dead":6,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小夜行","name":"小夜行","job":"铁衣","killStr":"0/0","kill":0,"assist":54,"res":0,"dmg":17689487,"tower":1338494,"heal":6949481,"taken":197699905,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小封印","name":"小封印","job":"玄机","killStr":"10/7","kill":17,"assist":36,"res":0,"dmg":128205313,"tower":1734072,"heal":2887594,"taken":53251020,"dead":9,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"非相","name":"非相","job":"潮光","killStr":"1/1","kill":2,"assist":47,"res":0,"dmg":18235771,"tower":13624617,"heal":16200024,"taken":34666760,"dead":12,"reviveStr":"12","revive":12,"fengu":0,"guildName":"仗剑"},{"id":"小袖气","name":"小袖气","job":"素问","killStr":"0/0","kill":0,"assist":54,"res":0,"dmg":523100,"tower":94744,"heal":148079276,"taken":53587324,"dead":1,"reviveStr":"10","revive":10,"fengu":0,"guildName":"仗剑"},{"id":"沅芷","name":"沅芷","job":"素问","killStr":"0/0","kill":0,"assist":53,"res":0,"dmg":1726122,"tower":139456,"heal":173510580,"taken":90663583,"dead":1,"reviveStr":"11","revive":11,"fengu":0,"guildName":"仗剑"},{"id":"脸红专家","name":"脸红专家","job":"素问","killStr":"0/0","kill":0,"assist":56,"res":0,"dmg":1520825,"tower":62233,"heal":217449679,"taken":73681677,"dead":1,"reviveStr":"10","revive":10,"fengu":0,"guildName":"仗剑"},{"id":"絵空事","name":"絵空事","job":"潮光","killStr":"2/0","kill":2,"assist":32,"res":0,"dmg":24957649,"tower":16242215,"heal":9840478,"taken":37794636,"dead":4,"reviveStr":"11","revive":11,"fengu":0,"guildName":"仗剑"},{"id":"余余","name":"余余","job":"素问","killStr":"0/0","kill":0,"assist":54,"res":0,"dmg":296571,"tower":32219,"heal":149766019,"taken":51291057,"dead":4,"reviveStr":"9","revive":9,"fengu":0,"guildName":"仗剑"},{"id":"小郎君","name":"小郎君","job":"龙吟","killStr":"3/0","kill":3,"assist":22,"res":0,"dmg":36478678,"tower":26667426,"heal":2774486,"taken":49649792,"dead":0,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小初秋","name":"小初秋","job":"潮光","killStr":"1/0","kill":1,"assist":26,"res":0,"dmg":40641270,"tower":0,"heal":14436393,"taken":98852455,"dead":1,"reviveStr":"11","revive":11,"fengu":0,"guildName":"仗剑"},{"id":"之麟","name":"之麟","job":"神相","killStr":"3/2","kill":5,"assist":41,"res":0,"dmg":142795904,"tower":0,"heal":860483,"taken":67480108,"dead":11,"reviveStr":"0","revive":0,"fengu":0,"guildName":"仗剑"},{"id":"小茉宁","name":"小茉宁","job":"素问","killStr":"0/0","kill":0,"assist":35,"res":0,"dmg":1901782,"tower":0,"heal":269260627,"taken":67141473,"dead":0,"reviveStr":"18","revive":18,"fengu":0,"guildName":"仗剑"}]}},"assignments":{},"formation":"424"};</script>
    <title>逆水寒帮战数据分析台 - 最终修复版</title>
    <style>
        :root {
            --bg-main: #f4f6f9;
            --bg-panel: #ffffff;
            --bg-header: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e0e0e0;
            --accent: #2c3e50;
            --highlight: #3498db;
            
            /* 职业颜色 */
            --c-suwen: #ff69b4; --c-tieyi: #b8860b; --c-longyin: #32cd32; --c-suimeng: #00bfff;
            --c-xuehe: #dc143c; --c-shenxiang: #1e90ff; --c-jiuling: #9932cc; --c-canglan: #00008b;
            --c-chaoguang: #4682b4; --c-xuanji: #d4ac0d;
        }

        body { font-family: "Microsoft YaHei", sans-serif; background-color: var(--bg-main); color: var(--text-main); margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1900px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }
        .btn { background: #fff; border: 1px solid #ccc; color: #333; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
        .btn:hover { background: var(--highlight); color: #fff; border-color: var(--highlight); }
        .btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-danger { color: #e74c3c; border-color: #e74c3c; }
        .btn-danger:hover { background: #e74c3c; color: #fff; }
        .btn-primary { color: var(--highlight); border-color: var(--highlight); }
        .btn-primary:hover { background: var(--highlight); color: #fff; }

        /* 头部 */
        header { background: var(--bg-header); padding: 10px 20px; border-bottom: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--accent); }

        /* 只读模式下的隐藏 */
        body.read-only .no-export { display: none !important; }
        body.read-only .export-badge { display: inline-block !important; }
        .export-badge { display: none; background: #e67e22; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; vertical-align: middle; }

        /* 看板 & 王牌 */
        .scoreboard { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; background: var(--bg-panel); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; align-items: center; }
        .guild-stat { text-align: center; }
        .guild-stat h2 { margin: 0 0 10px 0; font-size: 1.8rem; }
        .vs-badge { font-size: 3rem; font-weight: 900; color: #e74c3c; font-style: italic; }
        .stat-metrics { display: flex; justify-content: center; gap: 20px; }
        .metric-box { background: #f8f9fa; padding: 10px 20px; border-radius: 6px; border: 1px solid #eee; min-width: 80px; }
        .metric-val { display: block; font-size: 1.2rem; font-weight: bold; }
        .metric-label { font-size: 0.8rem; color: #888; }

        .ace-section { margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        .ace-header { text-align: center; margin-bottom: 10px; font-weight: bold; color: var(--accent); border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .ace-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; }
        .ace-card { border: 1px solid #eee; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; background: #fafafa; }
        .ace-title { background: #eef2f7; padding: 5px; text-align: center; font-size: 0.85rem; font-weight: bold; color: #555; }
        .ace-content { padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85rem; }
        .ace-side { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .ace-name { font-weight: bold; margin-bottom: 2px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .ace-val { font-size: 0.8rem; color: #666; }

        /* 导航 & 布局 */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .planner-container { display: flex; height: calc(100vh - 200px); gap: 15px; }
        
        /* 团配 */
        .roster-panel { width: 280px; background: #fff; border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: column; flex-shrink: 0; }
        .roster-header { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; }
        .roster-list { flex: 1; overflow-y: auto; padding: 5px; }
        .roster-item { padding: 6px 10px; margin-bottom: 4px; background: #fff; border: 1px solid #eee; border-radius: 3px; cursor: grab; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .roster-item:hover { background: #f0f7ff; border-color: #cce5ff; }
        
        .planner-board { flex: 1; overflow: auto; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .config-bar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 4px; flex-wrap: wrap; }
        .groups-wrapper { display: flex; gap: 15px; align-items: flex-start; } 
        .raid-group { background: #fff; border: 2px solid #333; border-radius: 4px; min-width: 200px; }
        .raid-group.attack { border-color: #e74c3c; } .attack .group-head { background: #e74c3c; }
        .raid-group.mobile { border-color: #f39c12; } .mobile .group-head { background: #f39c12; }
        .raid-group.defend { border-color: #2980b9; } .defend .group-head { background: #2980b9; }

        .group-head { padding: 8px; color: #fff; text-align: center; font-weight: bold; font-size: 1.1rem; }
        .group-notes { padding: 8px; font-size: 0.85rem; background: #fff3cd; color: #856404; border-bottom: 1px solid #eee; min-height: 40px; white-space: pre-wrap; }
        .teams-container { display: flex; padding: 5px; gap: 5px; }
        .team-col { width: 130px; display: flex; flex-direction: column; gap: 4px; }
        .team-title { text-align: center; font-weight: bold; background: #eee; padding: 4px; font-size: 0.9rem; border-radius: 3px; }
        .slot-box { height: 36px; border: 1px dashed #ccc; background: #fcfcfc; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; cursor: pointer; transition: 0.2s; position: relative; }
        .slot-box:hover { background: #f0f0f0; }
        .slot-box.drag-over { background: #e8f0fe; border-style: solid; border-color: #3498db; }
        .slot-player { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.3); font-weight: 500; cursor: grab; }

        /* 表格 & 雷达 */
        .table-controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;}
        .data-table-wrapper { overflow-x: auto; background: #fff; border: 1px solid #ddd; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th, td { padding: 8px 12px; border: 1px solid #eee; text-align: center; }
        th { background: #f4f6f9; font-weight: bold; cursor: pointer; user-select: none; }
        th:hover { background: #e9ecef; }
        tr:nth-child(even) { background: #fafafa; }
        tr:hover { background: #f0f7ff; }

        .radar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .radar-card { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .radar-sub { font-size: 0.8rem; color: #888; margin-top: 2px; }
        .radar-data-container { margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 5px; }
        .radar-data-row { display: flex; justify-content: center; gap: 8px; font-size: 0.75rem; color: #555; margin-bottom: 2px; flex-wrap: wrap;}
        .radar-val-item { background: #f9f9f9; padding: 2px 5px; border-radius: 3px; border: 1px solid #eee; }

        /* 颜色辅助 */
        .c-素问 { color: var(--c-suwen); } .bg-素问 { background-color: var(--c-suwen); }
        .c-铁衣 { color: var(--c-tieyi); } .bg-铁衣 { background-color: var(--c-tieyi); }
        .c-龙吟 { color: var(--c-longyin); } .bg-龙吟 { background-color: var(--c-longyin); }
        .c-碎梦 { color: var(--c-suimeng); } .bg-碎梦 { background-color: var(--c-suimeng); }
        .c-血河 { color: var(--c-xuehe); } .bg-血河 { background-color: var(--c-xuehe); }
        .c-神相 { color: var(--c-shenxiang); } .bg-神相 { background-color: var(--c-shenxiang); }
        .c-九灵 { color: var(--c-jiuling); } .bg-九灵 { background-color: var(--c-jiuling); }
        .c-沧澜 { color: var(--c-canglan); } .bg-沧澜 { background-color: var(--c-canglan); }
        .c-潮光 { color: var(--c-chaoguang); } .bg-潮光 { background-color: var(--c-chaoguang); }
        .c-玄机 { color: var(--c-xuanji); } .bg-玄机 { background-color: var(--c-xuanji); }
        
        select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .status-msg { margin-right: 15px; color: #27ae60; font-size: 0.9rem; display: none; }

        /* --- 移动端适配 --- */
        @media screen and (max-width: 768px) {
            .container { padding: 10px; }
            header { flex-direction: column; align-items: stretch; gap: 15px; }
            h1 { text-align: center; font-size: 1.2rem; }
            .no-export { display: flex; flex-direction: column; width: 100%; gap: 10px; }
            .no-export .btn, .no-export label { width: 100%; margin: 0 !important; text-align: center; padding: 10px; box-sizing: border-box; }
            .export-only .btn { width: 100%; padding: 10px; margin-bottom: 10px; }
            .status-msg { text-align: center; display: block !important; margin: 0 0 5px 0; }
            .scoreboard { grid-template-columns: 1fr; gap: 15px; padding: 15px; }
            .vs-badge { grid-row: 1; margin: 0; font-size: 2rem; text-align: center; }
            .guild-stat { display: flex; flex-direction: column; gap: 5px; }
            .guild-stat h2 { font-size: 1.5rem; }
            .stat-metrics { flex-wrap: wrap; gap: 8px; }
            .metric-box { flex: 1 1 30%; min-width: auto; padding: 8px 5px; }
            .metric-val { font-size: 1rem; }
            .ace-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .ace-card { font-size: 0.8rem; }
            .ace-content { grid-template-columns: 1fr; gap: 2px; }
            .ace-side { border-left: none !important; border-top: 1px solid #eee; padding-top: 2px; }
            .ace-side:first-child { border-top: none; padding-top: 0; padding-bottom: 2px; }
            .planner-container { flex-direction: column; height: auto; }
            .roster-panel { width: 100%; height: 250px; }
            .planner-board { padding: 10px; }
            .groups-wrapper { flex-direction: column; width: 100%; }
            .raid-group { width: 100%; min-width: 0; }
            .teams-container { flex-wrap: wrap; justify-content: flex-start; }
            .team-col { width: calc(50% - 5px); flex-grow: 1; }
            .radar-grid { grid-template-columns: 1fr; }
            .radar-card { padding: 10px; }
            canvas { max-width: 100%; height: auto; }
            .nav-tabs .btn { padding: 8px 12px; font-size: 0.85rem; }
            .table-controls { flex-direction: column; align-items: stretch; }
            .table-controls select, .table-controls input { width: 100%; box-sizing: border-box; }
        }

        @media print {
            .no-export, .nav-tabs, .config-bar button, .table-controls, .planner-container .roster-panel { display: none !important; }
            .planner-container { display: block; height: auto; }
            .planner-board { border: none; overflow: visible; }
            .groups-wrapper { flex-wrap: wrap; }
            .raid-group { margin-bottom: 20px; page-break-inside: avoid; }
            body { background: #fff; }
            .container { max-width: 100%; padding: 0; }
            .view-panel { display: block !important; margin-bottom: 30px; page-break-after: always; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>逆水寒帮战数据分析台 <span style="font-size:0.8em; color:#888;">| 苍梧版</span> <span class="export-badge">战报只读模式</span></h1>
    <div class="no-export">
        <span id="loadStatus" class="status-msg" style="display: none;">已加载上次保存的数据</span>
        <button class="btn btn-primary" onclick="exportReport()" style="margin-right:10px;">导出战报 (HTML)</button>
        <button class="btn btn-danger" onclick="clearLocalData()" style="margin-right:10px;">清除缓存</button>
        <label for="fileInput" class="btn" style="display:inline-block; padding:8px 20px;">上传CSV</label>
        <input type="file" id="fileInput" accept=".csv" class="hidden">
    </div>
    <div class="export-only hidden">
        <button class="btn" onclick="window.print()">打印 / 另存PDF</button>
    </div>
</header>

<div class="container" id="mainApp">
    <!-- 1. 战报看板 -->
    <div class="scoreboard">
        <div class="guild-stat">
            <h2 id="gA-name" style="color:var(--accent)">横戈</h2>
            <div class="stat-metrics">
                <div class="metric-box">
                    <span class="metric-label">总击败/清泉</span>
                    <span class="metric-val c-血河" id="gA-kills">203</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">总人伤</span>
                    <span class="metric-val c-碎梦" id="gA-dmg">187287.9w</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">总塔伤</span>
                    <span class="metric-val c-玄机" id="gA-tower">24247.5w</span>
                </div>
            </div>
        </div>
        <div class="vs-badge">VS</div>
        <div class="guild-stat">
            <h2 id="gB-name" style="color:#666">仗剑</h2>
            <div class="stat-metrics">
                <div class="metric-box">
                    <span class="metric-label">总击败/清泉</span>
                    <span class="metric-val c-血河" id="gB-kills">135</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">总人伤</span>
                    <span class="metric-val c-碎梦" id="gB-dmg">164679.1w</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">总塔伤</span>
                    <span class="metric-val c-玄机" id="gB-tower">15265.0w</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 王牌对比 -->
    <div class="ace-section">
        <div class="ace-header">双帮王牌对位</div>
        <div class="ace-grid" id="aceGrid"><div class="ace-card"><div class="ace-title">重伤王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-碎梦">奔雷</div><div class="ace-val">12次</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-潮光">非相</div><div class="ace-val">12次</div></div>
        </div></div><div class="ace-card"><div class="ace-title">塔伤王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-沧澜">天蝎</div><div class="ace-val">4433w</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-龙吟">小郎君</div><div class="ace-val">2667w</div></div>
        </div></div><div class="ace-card"><div class="ace-title">人伤王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-九灵">温言</div><div class="ace-val">15755w</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-神相">柠澈澈</div><div class="ace-val">14759w</div></div>
        </div></div><div class="ace-card"><div class="ace-title">综合王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-沧澜">天蝎</div><div class="ace-val">12254w</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-沧澜">雁鸣</div><div class="ace-val">6664w</div></div>
        </div></div><div class="ace-card"><div class="ace-title">击败/清泉王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-碎梦">清尔</div><div class="ace-val">17/10</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-碎梦">极意</div><div class="ace-val">11/7</div></div>
        </div></div><div class="ace-card"><div class="ace-title">承伤王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-铁衣">知源</div><div class="ace-val">20972w</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-铁衣">小夜行</div><div class="ace-val">19770w</div></div>
        </div></div><div class="ace-card"><div class="ace-title">治疗王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-素问">月揽霜</div><div class="ace-val">23803w</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-素问">小茉宁</div><div class="ace-val">26926w</div></div>
        </div></div><div class="ace-card"><div class="ace-title">化羽/清泉王</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-素问">月揽霜</div><div class="ace-val">17</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-素问">牙牙</div><div class="ace-val">18</div></div>
        </div></div></div>
    </div>

    <!-- 导航 -->
    <div class="nav-tabs">
        <button class="btn active" onclick="switchTab('planner')">团配指挥系统</button>
        <button class="btn" onclick="switchTab('radar')">全员职业雷达</button>
        <button class="btn" onclick="switchTab('data')">原始数据总表</button>
        <button class="btn" onclick="switchTab('raiddata')">分团详细数据</button>
    </div>

    <!-- 内容区 -->
    <div id="view-planner" class="view-panel">
        <div class="config-bar">
            <span><strong>阵型配置:</strong></span>
            <input type="text" id="formationInput" value="424" onchange="initRaidBoard(true)" style="width:50px; text-align:center; padding:5px;" placeholder="424">
            <span class="no-export" style="font-size:0.8rem; color:#666;">(例: 424 = 进攻4队 机动2队 防守4队)</span>
            <button class="btn no-export" onclick="initRaidBoard(true)">重置表格</button>
            <div style="flex:1"></div>
            <span class="no-export" style="font-size:0.85rem; color:red;">* 支持拖拽人员到表格，也支持表格内人员互换 (自动保存)</span>
        </div>
        <div class="planner-container">
            <div class="roster-panel no-export">
                <div class="roster-header">未分配人员 (<span id="unassignedCount">30</span>)</div>
                <div class="roster-list" id="rosterList" ondragover="allowDrop(event)" ondrop="dropToRoster(event)"><div class="roster-item c-素问" draggable="true"><span>婉心</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>月揽霜</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>花萦</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>桃沫</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>祺祺</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>檀柠</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-素问" draggable="true"><span>白晶晶</span> <span style="font-size:0.8em; color:#999">素问</span></div><div class="roster-item c-铁衣" draggable="true"><span>超级万万</span> <span style="font-size:0.8em; color:#999">铁衣</span></div><div class="roster-item c-铁衣" draggable="true"><span>知源</span> <span style="font-size:0.8em; color:#999">铁衣</span></div><div class="roster-item c-铁衣" draggable="true"><span>加加子</span> <span style="font-size:0.8em; color:#999">铁衣</span></div><div class="roster-item c-龙吟" draggable="true"><span>寒蟬丶</span> <span style="font-size:0.8em; color:#999">龙吟</span></div><div class="roster-item c-龙吟" draggable="true"><span>小陆远</span> <span style="font-size:0.8em; color:#999">龙吟</span></div><div class="roster-item c-碎梦" draggable="true"><span>孔少</span> <span style="font-size:0.8em; color:#999">碎梦</span></div><div class="roster-item c-碎梦" draggable="true"><span>清尔</span> <span style="font-size:0.8em; color:#999">碎梦</span></div><div class="roster-item c-碎梦" draggable="true"><span>奔雷</span> <span style="font-size:0.8em; color:#999">碎梦</span></div><div class="roster-item c-血河" draggable="true"><span>下次一定</span> <span style="font-size:0.8em; color:#999">血河</span></div><div class="roster-item c-血河" draggable="true"><span>咬鹃</span> <span style="font-size:0.8em; color:#999">血河</span></div><div class="roster-item c-神相" draggable="true"><span>塔左那个潮光</span> <span style="font-size:0.8em; color:#999">神相</span></div><div class="roster-item c-神相" draggable="true"><span>琳恩</span> <span style="font-size:0.8em; color:#999">神相</span></div><div class="roster-item c-九灵" draggable="true"><span>温言</span> <span style="font-size:0.8em; color:#999">九灵</span></div><div class="roster-item c-九灵" draggable="true"><span>拓海</span> <span style="font-size:0.8em; color:#999">九灵</span></div><div class="roster-item c-沧澜" draggable="true"><span>天蝎</span> <span style="font-size:0.8em; color:#999">沧澜</span></div><div class="roster-item c-沧澜" draggable="true"><span>醉千千</span> <span style="font-size:0.8em; color:#999">沧澜</span></div><div class="roster-item c-潮光" draggable="true"><span>京剧</span> <span style="font-size:0.8em; color:#999">潮光</span></div><div class="roster-item c-潮光" draggable="true"><span>浅念丶</span> <span style="font-size:0.8em; color:#999">潮光</span></div><div class="roster-item c-潮光" draggable="true"><span>清椽</span> <span style="font-size:0.8em; color:#999">潮光</span></div><div class="roster-item c-潮光" draggable="true"><span>林志玲</span> <span style="font-size:0.8em; color:#999">潮光</span></div><div class="roster-item c-潮光" draggable="true"><span>东方月初</span> <span style="font-size:0.8em; color:#999">潮光</span></div><div class="roster-item c-玄机" draggable="true"><span>凡也</span> <span style="font-size:0.8em; color:#999">玄机</span></div><div class="roster-item c-玄机" draggable="true"><span>邀明月</span> <span style="font-size:0.8em; color:#999">玄机</span></div></div>
            </div>
            <div class="planner-board"><div class="groups-wrapper" id="raidBoard"><div class="raid-group attack"><div class="group-head">进攻团 (24人)</div><div class="group-notes" contenteditable="true">指挥：XXX
团配：莲花+刷水，奶绝，约定，冰墙，太极</div><div class="teams-container"><div class="team-col"><div class="team-title">进攻1队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">进攻2队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">进攻3队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">进攻4队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div></div></div><div class="raid-group mobile"><div class="group-head">机动团 (12人)</div><div class="group-notes" contenteditable="true">指挥：XXX
团配：莲花+刷水，奶绝，约定，冰墙，太极</div><div class="teams-container"><div class="team-col"><div class="team-title">机动1队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">机动2队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div></div></div><div class="raid-group defend"><div class="group-head">防守团 (24人)</div><div class="group-notes" contenteditable="true">指挥：XXX
团配：莲花+冰墙+无情，太极，猫猫蛋，九天/压力大</div><div class="teams-container"><div class="team-col"><div class="team-title">防守1队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">防守2队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">防守3队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div><div class="team-col"><div class="team-title">防守4队</div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div><div class="slot-box"></div></div></div></div></div></div>
        </div>
    </div>

    <div id="view-radar" class="view-panel hidden">
        <div class="config-bar">
            <strong>雷达筛选：</strong>
            <select id="radarGroupFilter" onchange="renderRadar()">
                <option value="all">全部分团</option>
                <option value="attack">进攻团</option>
                <option value="mobile">机动团</option>
                <option value="defend">防守团</option>
                <option value="none">未分配</option>
            </select>
            <select id="radarClassFilter" onchange="renderRadar()">
                <option value="all">全职业</option>
            <option value="素问">素问</option><option value="铁衣">铁衣</option><option value="龙吟">龙吟</option><option value="碎梦">碎梦</option><option value="血河">血河</option><option value="神相">神相</option><option value="九灵">九灵</option><option value="沧澜">沧澜</option><option value="潮光">潮光</option><option value="玄机">玄机</option></select>
            <div style="flex:1"></div>
            <span style="color:#888; font-size:0.8rem;">显示所有核心数据</span>
        </div>
        <div class="radar-grid" id="radarContainer"></div>
    </div>

    <div id="view-data" class="view-panel hidden">
        <div class="table-controls">
            <select id="filterGuild" onchange="renderMainTable()">
                <option value="all">所有帮派</option>
                <option value="A" selected="">我方帮派</option>
                <option value="B">敌对帮派</option>
            </select>
            <select id="filterClass" onchange="renderMainTable()">
                <option value="all">全职业</option>
            <option value="素问">素问</option><option value="铁衣">铁衣</option><option value="龙吟">龙吟</option><option value="碎梦">碎梦</option><option value="血河">血河</option><option value="神相">神相</option><option value="九灵">九灵</option><option value="沧澜">沧澜</option><option value="潮光">潮光</option><option value="玄机">玄机</option></select>
            <input type="text" id="searchName" placeholder="搜索ID..." oninput="renderMainTable()" style="padding:5px;">
        </div>
        <div class="data-table-wrapper">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('mainTable', 0)">帮派</th>
                        <th onclick="sortTable('mainTable', 1)">ID</th>
                        <th onclick="sortTable('mainTable', 2)">职业</th>
                        <th onclick="sortTable('mainTable', 3, true)">击败/清泉</th>
                        <th onclick="sortTable('mainTable', 4, true)">助攻</th>
                        <th onclick="sortTable('mainTable', 5, true)">人伤</th>
                        <th onclick="sortTable('mainTable', 6, true)">塔伤</th>
                        <th onclick="sortTable('mainTable', 7, true)">承伤</th>
                        <th onclick="sortTable('mainTable', 8, true)">治疗</th>
                        <th onclick="sortTable('mainTable', 9, true)">重伤</th>
                        <th onclick="sortTable('mainTable', 10, true)">化羽/清泉</th>
                        <th onclick="sortTable('mainTable', 11, true)">资源</th>
                        <th onclick="sortTable('mainTable', 12, true)">焚骨</th>
                    </tr>
                </thead>
                <tbody><tr><td>横戈</td><td class="c-素问">花萦</td><td>素问</td><td data-val="0">0/0</td><td>70</td><td>186.7w</td><td>47.1w</td><td>4368.3w</td><td>21649.4w</td><td>3</td><td data-val="6">6</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-铁衣">知源</td><td>铁衣</td><td data-val="1">1/0</td><td>95</td><td>2784.0w</td><td>0.0w</td><td>20972.2w</td><td>781.9w</td><td>0</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-碎梦">奔雷</td><td>碎梦</td><td data-val="25">18/7</td><td>38</td><td>10661.1w</td><td>0.0w</td><td>4057.0w</td><td>314.4w</td><td>12</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-铁衣">加加子</td><td>铁衣</td><td data-val="2">1/1</td><td>65</td><td>2312.8w</td><td>676.3w</td><td>8615.2w</td><td>370.3w</td><td>0</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-潮光">东方月初</td><td>潮光</td><td data-val="1">1/0</td><td>39</td><td>2050.1w</td><td>2442.5w</td><td>2776.6w</td><td>671.4w</td><td>2</td><td data-val="8">8</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-龙吟">寒蟬丶</td><td>龙吟</td><td data-val="6">6/0</td><td>38</td><td>4851.7w</td><td>3947.6w</td><td>2591.0w</td><td>122.7w</td><td>0</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">月揽霜</td><td>素问</td><td data-val="0">0/0</td><td>68</td><td>290.8w</td><td>0.0w</td><td>7481.7w</td><td>23802.7w</td><td>0</td><td data-val="17">17</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-玄机">邀明月</td><td>玄机</td><td data-val="14">12/2</td><td>42</td><td>10977.6w</td><td>374.2w</td><td>4321.0w</td><td>273.2w</td><td>2</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-沧澜">醉千千</td><td>沧澜</td><td data-val="3">2/1</td><td>41</td><td>4119.0w</td><td>2987.0w</td><td>5622.9w</td><td>3.5w</td><td>1</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-血河">下次一定</td><td>血河</td><td data-val="9">7/2</td><td>48</td><td>13483.4w</td><td>0.0w</td><td>6160.8w</td><td>1402.2w</td><td>3</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">祺祺</td><td>素问</td><td data-val="0">0/0</td><td>66</td><td>53.1w</td><td>15.2w</td><td>2888.8w</td><td>11112.9w</td><td>0</td><td data-val="1">1</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">白晶晶</td><td>素问</td><td data-val="0">0/0</td><td>64</td><td>26.2w</td><td>1.2w</td><td>4568.9w</td><td>9693.2w</td><td>1</td><td data-val="4">4</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-碎梦">孔少</td><td>碎梦</td><td data-val="26">18/8</td><td>36</td><td>12744.7w</td><td>0.0w</td><td>3625.6w</td><td>2.6w</td><td>5</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-潮光">清椽</td><td>潮光</td><td data-val="2">2/0</td><td>70</td><td>3502.4w</td><td>0.0w</td><td>7063.5w</td><td>1938.8w</td><td>0</td><td data-val="7">7</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-神相">塔左那个潮光</td><td>神相</td><td data-val="14">9/5</td><td>61</td><td>12016.8w</td><td>0.0w</td><td>5587.4w</td><td>364.0w</td><td>8</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-玄机">凡也</td><td>玄机</td><td data-val="21">14/7</td><td>45</td><td>12152.4w</td><td>370.0w</td><td>3287.8w</td><td>235.3w</td><td>9</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-九灵">拓海</td><td>九灵</td><td data-val="7">5/2</td><td>65</td><td>14973.2w</td><td>0.0w</td><td>6216.4w</td><td>208.3w</td><td>5</td><td data-val="0">0</td><td>0</td><td>18</td></tr><tr><td>横戈</td><td class="c-九灵">温言</td><td>九灵</td><td data-val="8">6/2</td><td>56</td><td>15754.7w</td><td>0.0w</td><td>4222.1w</td><td>170.8w</td><td>6</td><td data-val="0">0</td><td>0</td><td>7</td></tr><tr><td>横戈</td><td class="c-碎梦">清尔</td><td>碎梦</td><td data-val="27">17/10</td><td>35</td><td>11130.7w</td><td>93.5w</td><td>4163.8w</td><td>4.0w</td><td>7</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-神相">琳恩</td><td>神相</td><td data-val="8">5/3</td><td>68</td><td>11281.4w</td><td>0.0w</td><td>8497.0w</td><td>459.7w</td><td>11</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-龙吟">小陆远</td><td>龙吟</td><td data-val="2">2/0</td><td>43</td><td>4315.5w</td><td>3433.6w</td><td>4561.4w</td><td>254.9w</td><td>1</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">桃沫</td><td>素问</td><td data-val="0">0/0</td><td>67</td><td>172.7w</td><td>27.0w</td><td>5681.5w</td><td>12721.1w</td><td>0</td><td data-val="6">6</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-血河">咬鹃</td><td>血河</td><td data-val="7">5/2</td><td>50</td><td>9134.8w</td><td>161.0w</td><td>6742.7w</td><td>804.1w</td><td>2</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">婉心</td><td>素问</td><td data-val="0">0/0</td><td>73</td><td>357.0w</td><td>0.0w</td><td>8750.5w</td><td>23585.2w</td><td>0</td><td data-val="14">14</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-素问">檀柠</td><td>素问</td><td data-val="0">0/0</td><td>66</td><td>48.3w</td><td>1.3w</td><td>2622.7w</td><td>12612.3w</td><td>0</td><td data-val="6">6</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-沧澜">天蝎</td><td>沧澜</td><td data-val="4">4/0</td><td>46</td><td>7820.8w</td><td>4432.9w</td><td>4139.7w</td><td>17.5w</td><td>0</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-潮光">浅念丶</td><td>潮光</td><td data-val="0">0/0</td><td>42</td><td>4439.6w</td><td>2629.2w</td><td>3786.5w</td><td>1075.0w</td><td>0</td><td data-val="5">5</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-潮光">京剧</td><td>潮光</td><td data-val="9">5/4</td><td>95</td><td>10465.3w</td><td>0.0w</td><td>4338.0w</td><td>1438.5w</td><td>7</td><td data-val="13">13</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-铁衣">超级万万</td><td>铁衣</td><td data-val="3">2/1</td><td>60</td><td>3089.8w</td><td>515.2w</td><td>15488.6w</td><td>397.8w</td><td>2</td><td data-val="0">0</td><td>0</td><td>0</td></tr><tr><td>横戈</td><td class="c-潮光">林志玲</td><td>潮光</td><td data-val="4">4/0</td><td>58</td><td>2091.3w</td><td>2092.9w</td><td>3026.4w</td><td>1139.2w</td><td>1</td><td data-val="14">14</td><td>0</td><td>0</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="view-raiddata" class="view-panel hidden">
        <div class="config-bar">
            <strong>分团概览</strong>
            <span style="font-size:0.85rem; color:#666;">(仅显示我方已分配团人员)</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap:20px;">
            <div id="table-attack">
                <h3 style="margin:5px 0; color:#e74c3c;">进攻团</h3>
                <div class="data-table-wrapper"><table id="subTable-attack"><thead><tr><th onclick="sortSubTable(this,0)">队</th><th onclick="sortSubTable(this,1)">ID</th><th onclick="sortSubTable(this,2)">职业</th><th onclick="sortSubTable(this,3,1)">击败/清泉</th><th onclick="sortSubTable(this,4,1)">助攻</th><th onclick="sortSubTable(this,5,1)">人伤</th><th onclick="sortSubTable(this,6,1)">塔伤</th><th onclick="sortSubTable(this,7,1)">承伤</th><th onclick="sortSubTable(this,8,1)">治疗</th><th onclick="sortSubTable(this,9,1)">重伤</th><th onclick="sortSubTable(this,10,1)">化羽/清泉</th><th onclick="sortSubTable(this,11,1)">资源</th><th onclick="sortSubTable(this,12,1)">焚骨</th></tr></thead><tbody></tbody></table></div>
            </div>
            <div id="table-mobile">
                <h3 style="margin:5px 0; color:#f39c12;">机动团</h3>
                <div class="data-table-wrapper"><table id="subTable-mobile"><thead><tr><th onclick="sortSubTable(this,0)">队</th><th onclick="sortSubTable(this,1)">ID</th><th onclick="sortSubTable(this,2)">职业</th><th onclick="sortSubTable(this,3,1)">击败/清泉</th><th onclick="sortSubTable(this,4,1)">助攻</th><th onclick="sortSubTable(this,5,1)">人伤</th><th onclick="sortSubTable(this,6,1)">塔伤</th><th onclick="sortSubTable(this,7,1)">承伤</th><th onclick="sortSubTable(this,8,1)">治疗</th><th onclick="sortSubTable(this,9,1)">重伤</th><th onclick="sortSubTable(this,10,1)">化羽/清泉</th><th onclick="sortSubTable(this,11,1)">资源</th><th onclick="sortSubTable(this,12,1)">焚骨</th></tr></thead><tbody></tbody></table></div>
            </div>
            <div id="table-defend">
                <h3 style="margin:5px 0; color:#2980b9;">防守团</h3>
                <div class="data-table-wrapper"><table id="subTable-defend"><thead><tr><th onclick="sortSubTable(this,0)">队</th><th onclick="sortSubTable(this,1)">ID</th><th onclick="sortSubTable(this,2)">职业</th><th onclick="sortSubTable(this,3,1)">击败/清泉</th><th onclick="sortSubTable(this,4,1)">助攻</th><th onclick="sortSubTable(this,5,1)">人伤</th><th onclick="sortSubTable(this,6,1)">塔伤</th><th onclick="sortSubTable(this,7,1)">承伤</th><th onclick="sortSubTable(this,8,1)">治疗</th><th onclick="sortSubTable(this,9,1)">重伤</th><th onclick="sortSubTable(this,10,1)">化羽/清泉</th><th onclick="sortSubTable(this,11,1)">资源</th><th onclick="sortSubTable(this,12,1)">焚骨</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
// === 常量 & 状态 ===
const JOBS = ['素问','铁衣','龙吟','碎梦','血河','神相','九灵','沧澜','潮光','玄机'];
const NOTES_DEFAULT = { 'attack': '指挥：XXX\n团配：莲花+刷水，奶绝，约定，冰墙，太极', 'mobile': '指挥：XXX\n团配：莲花+刷水，奶绝，约定，冰墙，太极', 'defend': '指挥：XXX\n团配：莲花+冰墙+无情，太极，猫猫蛋，九天/压力大' };
// 更改 KEY 以强制刷新旧缓存
const STORAGE_KEY = 'nsh_raid_data_v2_fixed'; 

let rawData = { gA: null, gB: null }; 
let assignments = {}; 
let draggedPlayerId = null;
let isExportMode = false;

// === 初始化 ===
window.addEventListener('DOMContentLoaded', () => {
    initClassFilter();
    if (window.NSH_EXPORTED_DATA) loadFromExport();
    else loadFromLocal();
});
document.getElementById('fileInput').addEventListener('change', handleFile);

function initClassFilter() {
    const s1 = document.getElementById('filterClass'), s2 = document.getElementById('radarClassFilter');
    JOBS.forEach(j => {
        const o1=document.createElement('option'), o2=document.createElement('option');
        o1.value=j; o1.innerText=j; s1.appendChild(o1);
        o2.value=j; o2.innerText=j; s2.appendChild(o2);
    });
}

// === 文件解析 (核心修复部分) ===
function handleFile(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => { parseCSV(evt.target.result); document.getElementById('fileInput').value = ''; };
    reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    let guilds = [], currentG = null, isHeader = false;
    for (let i=0; i<lines.length; i++) {
        let line = lines[i].replace(/"/g, ''); // 简单去引号
        let cols = line.split(',');
        
        // 帮派行检测
        if (cols.length >= 2 && !isNaN(parseInt(cols[1])) && cols[1].length < 5) {
            if (currentG) guilds.push(currentG);
            currentG = { name: cols[0], players: [] }; isHeader = true; continue;
        }
        if (isHeader) { isHeader = false; continue; } 
        
        // 玩家数据行检测 (确保关键列存在)
        if (currentG && cols.length > 5 && cols[1]) {
            const kStr = cols[2] ? cols[2].trim() : "0/0";
            const rStr = cols[10] ? cols[10].trim() : "0/0";
            
            currentG.players.push({
                id: cols[0], name: cols[0], job: cols[1].trim(),
                killStr: kStr, // 保存原始字符串 "16/2"
                kill: parseSplit(kStr), // 保存计算值 18
                assist: parseInt(cols[3])||0, res: parseInt(cols[4])||0,
                dmg: parseInt(cols[5])||0, tower: parseInt(cols[6])||0, heal: parseInt(cols[7])||0,
                taken: parseInt(cols[8])||0, dead: parseInt(cols[9])||0,
                reviveStr: rStr, // 保存原始字符串 "5/1"
                revive: parseSplit(rStr), // 保存计算值 6
                fengu: parseInt(cols[11])||0, guildName: currentG.name
            });
        }
    }
    if (currentG) guilds.push(currentG);
    
    if (guilds.length > 0) {
        rawData.gA = guilds[0];
        rawData.gB = guilds.length > 1 ? guilds[1] : { name: "敌对未知", players: [] };
        assignments = {}; // 新文件重置分配
        document.getElementById('loadStatus').style.display = 'none';
        initUI();
        saveToLocal();
    } else {
        alert("解析失败：未找到有效数据，请确认CSV格式正确。");
    }
}
function parseSplit(str) { if (!str) return 0; return str.split('/').reduce((a,b)=>a+(parseInt(b)||0),0); }
function sum(arr, k) { return arr.reduce((a,b)=>a+b[k],0); }

// === UI 逻辑 ===
function updateScoreboard() {
    const setG = (prefix, g) => {
        document.getElementById(prefix+'-name').innerText = g.name;
        document.getElementById(prefix+'-kills').innerText = g.players.map(p=>p.killStr).join(' ').match(/(\d+)/g) ? sum(g.players,'kill') : 0; // 简单总和
        document.getElementById(prefix+'-dmg').innerText = (sum(g.players, 'dmg')/10000).toFixed(1) + 'w';
        document.getElementById(prefix+'-tower').innerText = (sum(g.players, 'tower')/10000).toFixed(1) + 'w';
    };
    setG('gA', rawData.gA); setG('gB', rawData.gB);
}

function updateAces() {
    const grid = document.getElementById('aceGrid'); grid.innerHTML = '';
    const criteria = [
        { label: '重伤王', key: 'dead', fmt: v=>v+'次' },
        { label: '塔伤王', key: 'tower', fmt: v=>(v/10000).toFixed(0)+'w' },
        { label: '人伤王', key: 'dmg', fmt: v=>(v/10000).toFixed(0)+'w' },
        { label: '综合王', key: 'hybrid', fmt: v=>(v/10000).toFixed(0)+'w', custom: p => (p.dmg>15000000 && p.tower>15000000) ? (p.dmg+p.tower) : 0 },
        { label: '击败/清泉王', key: 'kill', fmt: (v,p)=>p.killStr||v },
        { label: '承伤王', key: 'taken', fmt: v=>(v/10000).toFixed(0)+'w' },
        { label: '治疗王', key: 'heal', fmt: v=>(v/10000).toFixed(0)+'w' },
        { label: '化羽/清泉王', key: 'revive', fmt: (v,p)=>p.reviveStr||v },
    ];
    criteria.forEach(c => {
        const pA = getTop(rawData.gA.players, c), pB = getTop(rawData.gB.players, c);
        grid.innerHTML += `<div class="ace-card"><div class="ace-title">${c.label}</div><div class="ace-content">
            <div class="ace-side"><div class="ace-name c-${pA?pA.job:''}">${pA?pA.name:'-'}</div><div class="ace-val">${pA?c.fmt(c.custom?c.custom(pA):pA[c.key], pA):'-'}</div></div>
            <div class="ace-side" style="border-left:1px solid #eee;"><div class="ace-name c-${pB?pB.job:''}">${pB?pB.name:'-'}</div><div class="ace-val">${pB?c.fmt(c.custom?c.custom(pB):pB[c.key], pB):'-'}</div></div>
        </div></div>`;
    });
}
function getTop(list, c) {
    if(!list || list.length===0) return null;
    let sorted = [...list];
    if(c.key === 'hybrid') { sorted.sort((a,b) => c.custom(b) - c.custom(a)); return c.custom(sorted[0]) > 0 ? sorted[0] : null; }
    sorted.sort((a,b) => b[c.key] - a[c.key]); return sorted[0];
}

// === 团配 ===
function initRaidBoard(reset = false) {
    if (reset) { assignments = {}; saveToLocal(); }
    renderRoster(); renderBoardLayout();
}
function renderRoster() {
    const list = document.getElementById('rosterList'); list.innerHTML = '';
    const players = rawData.gA.players.filter(p => !assignments[p.id]); 
    players.sort((a,b) => (a.job === b.job) ? b.dmg - a.dmg : JOBS.indexOf(a.job) - JOBS.indexOf(b.job));
    document.getElementById('unassignedCount').innerText = players.length;
    players.forEach(p => {
        const el = document.createElement('div'); el.className = `roster-item c-${p.job}`; el.draggable = !isExportMode;
        el.innerHTML = `<span>${p.name}</span> <span style="font-size:0.8em; color:#999">${p.job}</span>`;
        if(!isExportMode) el.ondragstart = (e) => dragStart(e, p.id, 'roster');
        list.appendChild(el);
    });
}
function renderBoardLayout() {
    const con = document.getElementById('raidBoard'); con.innerHTML = '';
    const counts = (document.getElementById('formationInput').value||"424").split('').map(Number);
    const groups = [{id:'attack',name:'进攻团',cnt:counts[0]},{id:'mobile',name:'机动团',cnt:counts[1]},{id:'defend',name:'防守团',cnt:counts[2]}];
    groups.forEach(g => {
        const div = document.createElement('div'); div.className = `raid-group ${g.id}`;
        div.innerHTML = `<div class="group-head">${g.name} (${g.cnt*6}人)</div><div class="group-notes" contenteditable="${!isExportMode}">${NOTES_DEFAULT[g.id]}</div>`;
        const tCon = document.createElement('div'); tCon.className = 'teams-container';
        for(let t=0; t<g.cnt; t++) {
            const col = document.createElement('div'); col.className = 'team-col';
            col.innerHTML = `<div class="team-title">${g.name.substr(0,2)}${t+1}队</div>`;
            for(let s=0; s<6; s++) {
                const slot = document.createElement('div'); slot.className = 'slot-box';
                if(!isExportMode) {
                    slot.ondragover = allowDrop; slot.ondrop = (e) => dropToSlot(e, g.id, t, s);
                    slot.ondragenter = (e)=>e.target.closest('.slot-box').classList.add('drag-over');
                    slot.ondragleave = (e)=>e.target.closest('.slot-box').classList.remove('drag-over');
                }
                const pid = Object.keys(assignments).find(k => assignments[k].groupId === g.id && assignments[k].teamIdx === t && assignments[k].slotIdx === s);
                if(pid) {
                    const p = rawData.gA.players.find(x => x.id === pid);
                    const pEl = document.createElement('div'); pEl.className = `slot-player bg-${p.job}`; pEl.innerText = p.name;
                    pEl.draggable = !isExportMode; if(!isExportMode) pEl.ondragstart = (e) => dragStart(e, p.id, 'slot');
                    slot.appendChild(pEl);
                }
                col.appendChild(slot);
            }
            tCon.appendChild(col);
        }
        div.appendChild(tCon); con.appendChild(div);
    });
}
function dragStart(e, pid, src) { e.dataTransfer.setData('text', JSON.stringify({pid, src})); draggedPlayerId = pid; }
function allowDrop(e) { e.preventDefault(); }
function dropToSlot(e, gid, tid, sid) {
    e.preventDefault(); e.target.closest('.slot-box').classList.remove('drag-over');
    const data = JSON.parse(e.dataTransfer.getData('text')), pid = data.pid;
    const targetId = Object.keys(assignments).find(k => assignments[k].groupId === gid && assignments[k].teamIdx === tid && assignments[k].slotIdx === sid);
    if(targetId) { const org = assignments[pid]; if(org) assignments[targetId] = {...org}; else delete assignments[targetId]; }
    assignments[pid] = { groupId: gid, teamIdx: tid, slotIdx: sid }; refreshPlannerUI();
}
function dropToRoster(e) { e.preventDefault(); const data = JSON.parse(e.dataTransfer.getData('text')); if(assignments[data.pid]) { delete assignments[data.pid]; refreshPlannerUI(); }}
function refreshPlannerUI() { renderRoster(); renderBoardLayout(); renderSubTables(); saveToLocal(); }

// === 雷达 & 表格 ===
function renderRadar() {
    const con = document.getElementById('radarContainer'); con.innerHTML = '';
    const gF = document.getElementById('radarGroupFilter').value, cF = document.getElementById('radarClassFilter').value;
    let list = rawData.gA.players.filter(p => {
        const a = assignments[p.id];
        if(gF !== 'all') { if(gF === 'none') { if(a) return false; } else { if(!a || a.groupId !== gF) return false; } }
        if(cF !== 'all' && p.job !== cF) return false; return true;
    }).sort((a,b) => b.dmg - a.dmg);
    
    const getS = (k, f) => { let l = rawData.gA.players; if(f) l = l.filter(p=>f(p.job)); if(!l.length) return 1; l = [...l].sort((a,b)=>b[k]-a[k]).slice(0,10); return l.reduce((a,b)=>a+b[k],0)/l.length||1; };
    const s = { dmg: getS('dmg',j=>j!=='素问'), kill: getS('kill',j=>j!=='素问'), tower: getS('tower',j=>j!=='素问'), taken: getS('taken'), heal: getS('heal',j=>j==='素问'), revive: getS('revive',j=>['素问','潮光'].includes(j)), fengu: getS('fengu',j=>j==='九灵') };

    list.forEach(p => {
        const card = document.createElement('div'); card.className = 'radar-card';
        const a = assignments[p.id], gInfo = a ? `${{'attack':'进攻','mobile':'机动','defend':'防守'}[a.groupId]} ${a.teamIdx+1}队` : '未分配';
        const fW = v => (v/10000).toFixed(1)+'w';
        card.innerHTML = `<div class="c-${p.job}" style="font-weight:bold;font-size:1.1rem;">${p.name}</div><div class="radar-sub">${p.job} | ${gInfo}</div><canvas width="200" height="200"></canvas>
            <div class="radar-data-container"><div class="radar-data-row"><span class="radar-val-item">人:${fW(p.dmg)}</span><span class="radar-val-item">塔:${fW(p.tower)}</span><span class="radar-val-item">承:${fW(p.taken)}</span><span class="radar-val-item">疗:${fW(p.heal)}</span></div>
            <div class="radar-data-row"><span class="radar-val-item">击败:${p.killStr||p.kill}</span><span class="radar-val-item">助:${p.assist}</span><span class="radar-val-item">重:${p.dead}</span><span class="radar-val-item">羽:${p.reviveStr||p.revive}</span><span class="radar-val-item">焚:${p.fengu}</span></div></div>`;
        con.appendChild(card); drawCanvasRadar(card.querySelector('canvas'), p, s);
    });
    if(!list.length) con.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;">无数据</div>';
}
function drawCanvasRadar(canvas, p, s) {
    const ctx = canvas.getContext('2d'), cx=100, cy=100, r=70;
    let axes = []; const n = (v,m) => Math.min(1.2, v/m), nI = (v,m) => Math.min(1.2, Math.max(0.2, 1+(m-v)/m));
    if(p.job==='素问') axes=[{l:'生存',v:nI(p.dead,3)},{l:'承伤',v:n(p.taken,s.taken)},{l:'化羽',v:n(p.revive,s.revive)},{l:'治疗',v:n(p.heal,s.heal)}];
    else if(p.job==='潮光') axes=[{l:'人伤',v:n(p.dmg,s.dmg)},{l:'击败',v:n(p.kill,s.kill)},{l:'生存',v:nI(p.dead,4)},{l:'塔伤',v:n(p.tower,s.tower)},{l:'清泉',v:n(p.revive,s.revive)}];
    else if(p.job==='九灵') axes=[{l:'人伤',v:n(p.dmg,s.dmg)},{l:'击败',v:n(p.kill,s.kill)},{l:'生存',v:nI(p.dead,4)},{l:'承伤',v:n(p.taken,s.taken)},{l:'塔伤',v:n(p.tower,s.tower)},{l:'清泉',v:n(p.revive,s.revive)},{l:'焚骨',v:n(p.fengu,s.fengu)}];
    else axes=[{l:'人伤',v:n(p.dmg,s.dmg)},{l:'击败',v:n(p.kill,s.kill)},{l:'生存',v:nI(p.dead,4)},{l:'承伤',v:n(p.taken,s.taken)},{l:'塔伤',v:n(p.tower,s.tower)}];
    
    const step = (Math.PI*2)/axes.length;
    ctx.strokeStyle='#eee'; for(let l=1;l<=4;l++){ ctx.beginPath(); for(let i=0;i<axes.length;i++) ctx.lineTo(cx+Math.cos(i*step-Math.PI/2)*(r/4)*l, cy+Math.sin(i*step-Math.PI/2)*(r/4)*l); ctx.closePath(); ctx.stroke(); }
    ctx.fillStyle='rgba(52,152,219,0.2)'; ctx.strokeStyle='#3498db'; ctx.lineWidth=2; ctx.beginPath(); 
    for(let i=0;i<axes.length;i++) ctx.lineTo(cx+Math.cos(i*step-Math.PI/2)*r*axes[i].v, cy+Math.sin(i*step-Math.PI/2)*r*axes[i].v);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#666'; ctx.font='10px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    for(let i=0;i<axes.length;i++) ctx.fillText(axes[i].l, cx+Math.cos(i*step-Math.PI/2)*(r+15), cy+Math.sin(i*step-Math.PI/2)*(r+15));
}

function renderMainTable() {
    const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = '';
    const gF = document.getElementById('filterGuild').value, cF = document.getElementById('filterClass').value, s = document.getElementById('searchName').value.toLowerCase();
    let l = []; if(gF==='all'||gF==='A') rawData.gA.players.forEach(p=>l.push({...p,g:'我方'})); if(gF==='all'||gF==='B') rawData.gB.players.forEach(p=>l.push({...p,g:'敌对'}));
    l.filter(p => (cF==='all'||p.job===cF) && (!s||p.name.toLowerCase().includes(s))).forEach(p => tbody.innerHTML += rowHTML(p));
}
function renderSubTables() {
    const groups = ['attack','mobile','defend'];
    const h = `<tr><th onclick="sortSubTable(this,0)">队</th><th onclick="sortSubTable(this,1)">ID</th><th onclick="sortSubTable(this,2)">职业</th><th onclick="sortSubTable(this,3,1)">击败/清泉</th><th onclick="sortSubTable(this,4,1)">助攻</th><th onclick="sortSubTable(this,5,1)">人伤</th><th onclick="sortSubTable(this,6,1)">塔伤</th><th onclick="sortSubTable(this,7,1)">承伤</th><th onclick="sortSubTable(this,8,1)">治疗</th><th onclick="sortSubTable(this,9,1)">重伤</th><th onclick="sortSubTable(this,10,1)">化羽/清泉</th><th onclick="sortSubTable(this,11,1)">资源</th><th onclick="sortSubTable(this,12,1)">焚骨</th></tr>`;
    groups.forEach(gid => {
        document.querySelector(`#subTable-${gid} thead`).innerHTML = h;
        const tbody = document.querySelector(`#subTable-${gid} tbody`); tbody.innerHTML = '';
        const pids = Object.keys(assignments).filter(k => assignments[k].groupId === gid);
        const list = pids.map(id => { const p = rawData.gA.players.find(x=>x.id===id); return {...p, team: assignments[id].teamIdx+1}; }).sort((a,b)=>a.team-b.team);
        list.forEach(p => tbody.innerHTML += `<tr><td>${p.team}队</td><td class="c-${p.job}">${p.name}</td><td>${p.job}</td><td data-val="${p.kill}">${p.killStr||p.kill}</td><td>${p.assist}</td><td>${(p.dmg/10000).toFixed(1)}w</td><td>${(p.tower/10000).toFixed(1)}w</td><td>${(p.taken/10000).toFixed(1)}w</td><td>${(p.heal/10000).toFixed(1)}w</td><td>${p.dead}</td><td data-val="${p.revive}">${p.reviveStr||p.revive}</td><td>${p.res}</td><td>${p.fengu}</td></tr>`);
    });
}
function rowHTML(p) {
    return `<tr><td>${p.guildName||p.g}</td><td class="c-${p.job}">${p.name}</td><td>${p.job}</td><td data-val="${p.kill}">${p.killStr||p.kill}</td><td>${p.assist}</td><td>${(p.dmg/10000).toFixed(1)}w</td><td>${(p.tower/10000).toFixed(1)}w</td><td>${(p.taken/10000).toFixed(1)}w</td><td>${(p.heal/10000).toFixed(1)}w</td><td>${p.dead}</td><td data-val="${p.revive}">${p.reviveStr||p.revive}</td><td>${p.res}</td><td>${p.fengu}</td></tr>`;
}

let sortDir = {};
function sortTable(id, idx, num=false) {
    const tbody = document.querySelector(`#${id} tbody`), rows = Array.from(tbody.querySelectorAll('tr'));
    sortDir[id+idx] = !sortDir[id+idx]; const d = sortDir[id+idx] ? 1 : -1;
    rows.sort((a,b) => {
        let x = a.children[idx].dataset.val || a.children[idx].innerText, y = b.children[idx].dataset.val || b.children[idx].innerText;
        if(num) { x = parseFloat(x.replace('w',''))||0; y = parseFloat(y.replace('w',''))||0; return (x-y)*d; }
        return x.localeCompare(y)*d;
    });
    tbody.innerHTML = ''; rows.forEach(r => tbody.appendChild(r));
}
function sortSubTable(th, idx, num=false) { sortTable(th.closest('table').id, idx, num); }
function switchTab(id) {
    document.querySelectorAll('.view-panel').forEach(d => d.classList.add('hidden'));
    document.getElementById('view-'+id).classList.remove('hidden');
    document.querySelectorAll('.nav-tabs .btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
    if(id==='radar') renderRadar(); if(id==='raiddata') renderSubTables();
}

// === 通用 ===
function exportReport() {
    if (!rawData.gA) { alert("请先上传数据"); return; }
    const exportData = { rawData: rawData, assignments: assignments, formation: document.getElementById('formationInput').value };
    let htmlContent = document.documentElement.outerHTML;
    const injection = `window.NSH_EXPORTED_DATA = ${JSON.stringify(exportData)};`;
    htmlContent = htmlContent.replace('<script id="export-data-hook">window.NSH_EXPORTED_DATA = null;<\/script>', `<script id="export-data-hook">${injection}<\/script>`);
    const blob = new Blob([htmlContent], {type: 'text/html'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `帮战战报_${rawData.gA.name}_vs_${rawData.gB.name}_${new Date().toLocaleDateString()}.html`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function loadFromExport() {
    const data = window.NSH_EXPORTED_DATA; isExportMode = true;
    document.body.classList.add('read-only'); document.querySelector('.export-only').classList.remove('hidden');
    rawData = data.rawData; assignments = data.assignments || {};
    document.getElementById('formationInput').value = data.formation || "424"; document.getElementById('formationInput').disabled = true;
    initUI();
}
function loadFromLocal() {
    const json = localStorage.getItem(STORAGE_KEY);
    if (json) { try { const data = JSON.parse(json); if (data.rawData && data.rawData.gA) { rawData = data.rawData; assignments = data.assignments || {}; document.getElementById('formationInput').value = data.formation || "424"; document.getElementById('loadStatus').style.display = 'inline-block'; initUI(); } } catch(e) { console.error(e); } }
}
function initUI() {
    document.getElementById('mainApp').classList.remove('hidden');
    updateScoreboard(); updateAces(); renderRoster(); renderBoardLayout(); renderMainTable(); renderSubTables();
}
function saveToLocal() {
    if (isExportMode) return;
    const data = { rawData: rawData, assignments: assignments, formation: document.getElementById('formationInput').value };
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){}
}
function clearLocalData() { if(confirm('确定要清除所有缓存数据吗？')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
</script>

</body></html>